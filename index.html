<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDMap - Akƒ±llƒ± Harita</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #FAFAFA; color: #1A1A1A; overflow: hidden; }
        
        .header {
            background: white; padding: 14px 28px; display: flex; align-items: center; gap: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06); border-bottom: 1px solid #E8E8E8; position: relative; z-index: 1000;
        }
        .logo { height: 38px; width: auto; }
        .header h1 { font-size: 1.25em; margin: 0; font-weight: 600; color: #00438C; flex: 1; }
        
        .container { display: flex; height: calc(100vh - 66px); position: relative; }
        
        .sidebar {
            width: 320px; background: white; border-right: 1px solid #E8E8E8; overflow-y: auto;
            padding: 16px; transition: transform 0.3s ease, margin-left 0.3s ease; z-index: 999;
        }
        .sidebar.collapsed { transform: translateX(-100%); margin-left: -320px; }
        
        .section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #E8E8E8; }
        .section h2 { font-size: 0.9em; margin-bottom: 12px; font-weight: 600; color: #1A1A1A; }
        
        .upload-area {
            border: 1.5px dashed #E8E8E8; border-radius: 8px; padding: 20px; text-align: center;
            background: #FAFAFA; cursor: pointer; transition: all 0.25s;
        }
        .upload-area:hover { border-color: #007973; background: white; }
        #fileInput { display: none; }
        
        .drawing-tools { display: flex; gap: 8px; flex-wrap: wrap; }
        .draw-btn {
            flex: 1; min-width: 45%; padding: 10px; background: white; border: 1px solid #E8E8E8;
            border-radius: 6px; cursor: pointer; font-size: 0.85em;
        }
        .draw-btn:hover { border-color: #007973; background: #f9f9f9; }
        
        .file-item {
            background: white; border: 1px solid #E8E8E8; border-radius: 8px; padding: 12px; margin-bottom: 8px;
        }
        .file-name { font-weight: 500; font-size: 0.85em; margin-bottom: 6px; }
        .file-actions { display: flex; gap: 6px; }
        .btn { padding: 6px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; flex: 1; color: white; }
        .btn-toggle { background: #007973; } .btn-edit { background: #00ACE5; } .btn-remove { background: #E53935; }
        .btn-toggle.hidden { background: #D0D0D0; }
        
        /* AI Chat Styles */
        .ai-chat-toggle {
            width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .ai-chat-container {
            position: fixed; bottom: 20px; right: 20px; width: 400px; height: 500px;
            background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            display: none; flex-direction: column; z-index: 10000;
        }
        .ai-chat-container.active { display: flex; }
        .ai-chat-header {
            padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between;
        }
        .ai-chat-messages { flex: 1; overflow-y: auto; padding: 16px; background: #f9f9f9; }
        .ai-message { margin-bottom: 12px; padding: 10px 14px; border-radius: 8px; font-size: 0.85em; line-height: 1.5; }
        .ai-message.user { background: #667eea; color: white; margin-left: 40px; }
        .ai-message.assistant { background: white; color: #333; margin-right: 40px; border: 1px solid #e0e0e0; }
        .ai-chat-input-container { padding: 16px; border-top: 1px solid #e0e0e0; background: white; border-radius: 0 0 12px 12px; }
        .ai-chat-input { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; resize: none; }
        .ai-send-btn {
            margin-top: 8px; width: 100%; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;
        }

        #map { flex: 1; height: 100%; }
        
        /* Modals */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9998; }
        .modal-overlay.active { display: block; }
        .modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; z-index: 9999;
        }
        .modal.active { display: block; }
        .modal-input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #E8E8E8; border-radius: 6px; }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 66px; height: calc(100vh - 66px); z-index: 1001; }
            .sidebar.collapsed { transform: translateX(-100%); }
            .ai-chat-container { width: calc(100vw - 40px); height: 400px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://imar.istanbul/logo_ibb.png" alt="ƒ∞BB Logo" class="logo">
        <h1>EDMap</h1>
        <button onclick="toggleSidebar()" style="padding: 8px;">‚ò∞</button>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div id="successNotice" style="display:none; background:#d4edda; padding:10px; margin-bottom:10px; border-radius:6px; color:#155724;">‚úÖ Baƒülantƒ± Ba≈üarƒ±lƒ±</div>

            <div class="section">
                <h2>üó∫Ô∏è Harita Stili</h2>
                <select onchange="changeMapStyle()" id="mapStyleSelector" style="width:100%; padding:8px;">
                    <option value="streets">Sokaklar</option>
                    <option value="satellite">Uydu</option>
                    <option value="hybrid">Hibrit</option>
                </select>
            </div>

            <div class="section">
                <h2>‚úèÔ∏è √áizim Ara√ßlarƒ±</h2>
                <div class="drawing-tools">
                    <button class="draw-btn" onclick="startDrawing('marker')">üìç Pin</button>
                    <button class="draw-btn" onclick="startDrawing('polyline')">üìè √áizgi</button>
                    <button class="draw-btn" onclick="startDrawing('polygon')">‚¨° Alan</button>
                    <button class="draw-btn" onclick="clearDrawings()">üóëÔ∏è Temizle</button>
                </div>
            </div>

            <div class="section">
                <h2>üìÅ Dosya Y√ºkle</h2>
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 24px;">üì§</div>
                    <div>KML, KMZ, GeoJSON<br>S√ºr√ºkle ya da tƒ±kla</div>
                    <input type="file" id="fileInput" accept=".geojson,.json,.kml,.kmz" multiple>
                </div>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="section ai-chat-section">
                <button class="ai-chat-toggle" onclick="toggleAIChat()">ü§ñ AI Asistan ile Konu≈ü</button>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <div class="ai-chat-container" id="aiChatContainer">
        <div class="ai-chat-header">
            <h3>ü§ñ AI Asistan</h3>
            <button onclick="toggleAIChat()" style="background:transparent; border:none; color:white; cursor:pointer;">‚úï</button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message assistant">Merhaba! Haritadaki veriler hakkƒ±nda bana soru sorabilirsiniz.</div>
        </div>
        <div class="ai-chat-input-container">
            <textarea class="ai-chat-input" id="aiChatInput" placeholder="Sorunuzu yazƒ±n..." rows="2"></textarea>
            <button class="ai-send-btn" onclick="sendAIMessage()">G√∂nder</button>
        </div>
    </div>

    <div class="modal-overlay" id="nameModalOverlay"></div>
    <div class="modal" id="nameModal">
        <h2>Giri≈ü</h2>
        <input type="text" class="modal-input" id="userName" placeholder="Adƒ±nƒ±z">
        <input type="text" class="modal-input" id="userSurname" placeholder="Soyadƒ±nƒ±z">
        <button onclick="saveUserName()" class="ai-send-btn">Kaydet</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyATdNx8dAy47w1gfKwmgfG07Nq9a67M3oc",
            authDomain: "bbtunc-fc77e.firebaseapp.com",
            projectId: "bbtunc-fc77e",
            storageBucket: "bbtunc-fc77e.firebasestorage.app",
            messagingSenderId: "720873591864",
            appId: "1:720873591864:web:360507d11bb560082402cd"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth).then(() => {
                window.firebaseReady = true;
                document.getElementById('successNotice').style.display = 'block';
            });
        } catch(e) { console.error(e); }

        window.uploadToFirebase = async (data) => {
            if(!window.firebaseReady) return null;
            try { return (await addDoc(collection(window.db, 'maps'), {...data, createdAt: new Date().toISOString()})).id; }
            catch(e) { return null; }
        };
        
        window.loadFromFirebase = async (id) => {
            if(!window.firebaseReady) return null;
            try { return (await getDoc(doc(window.db, 'maps', id))).data(); }
            catch(e) { return null; }
        };
    </script>

    <script>
        // --- API KEY (G√úNCEL) ---
        const GEMINI_API_KEY = 'AIzaSyAjiSLksJYUnMlMppQ1gbclx-prQ5C70Ts'; 

        let map, drawnItems, currentUser;
        let loadedFiles = [];
        let currentLayer;

        window.onload = function() {
            initMap();
            checkUserName();
            setupFileUpload();
            setupDrawingTools();
            
            // Otomatik Y√ºklemeler
            autoLoadGithubKML();
            autoLoadGithubKMZ();
            
            // URL Share kontrol√º
            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('share');
            if(shareId) setTimeout(() => loadSharedMap(shareId), 1000);
        };

        function initMap() {
            map = L.map('map').setView([41.0082, 28.9784], 11);
            currentLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: '¬© OpenStreetMap'
            }).addTo(map);
            drawnItems = new L.FeatureGroup().addTo(map);
            L.control.scale().addTo(map);
        }

        // --- AI FONKSƒ∞YONLARI (G√úNCELLENDƒ∞) ---
        async function askGeminiAI(question, context) {
            try {
                // Sisteme talimat veriyoruz (Veriler json olarak gidecek)
                const systemPrompt = `Sen bir CBS ve Emlak asistanƒ±sƒ±n. 
                Sana verilen harita verileri ≈üunlar: ${JSON.stringify(context)}.
                Kullanƒ±cƒ±nƒ±n bu verilerle ilgili sorularƒ±nƒ± cevapla. Veri yoksa "Bu bilgi dosyada g√∂r√ºnm√ºyor" de.
                Soru: ${question}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: systemPrompt }] }]
                    })
                });

                const data = await response.json();
                
                if (!response.ok || data.error) {
                    return { error: true, message: 'API Hatasƒ±: ' + (data.error?.message || 'Bilinmiyor') };
                }
                
                return { error: false, message: data.candidates[0].content.parts[0].text };

            } catch (error) {
                return { error: true, message: 'Baƒülantƒ± hatasƒ±: ' + error.message };
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiChatInput');
            const message = input.value.trim();
            if (!message) return;

            addAIMessage(message, 'user');
            input.value = '';

            // Y√ºkleniyor...
            const loadingMsg = addAIMessage('Veriler analiz ediliyor...', 'assistant');

            // Harita verilerini hazƒ±rla (Sadece √∂zellikleri al, koordinatlarƒ± alma ki veri ≈üi≈ümesin)
            const mapContext = loadedFiles.map(f => {
                const geojson = f.layer.toGeoJSON();
                return {
                    fileName: f.name,
                    features: geojson.features.map(feat => feat.properties) // √ñzellikleri al
                };
            });

            const context = {
                files: mapContext,
                drawings: drawnItems.toGeoJSON().features.map(f => f.properties)
            };

            const response = await askGeminiAI(message, context);
            
            // Y√ºkleniyor mesajƒ±nƒ± kaldƒ±r
            loadingMsg.remove();
            
            addAIMessage(response.error ? '‚ö†Ô∏è ' + response.message : response.message, 'assistant');
        }

        function addAIMessage(text, type) {
            const div = document.createElement('div');
            div.className = `ai-message ${type}`;
            div.textContent = text;
            document.getElementById('aiChatMessages').appendChild(div);
            document.getElementById('aiChatMessages').scrollTop = 99999;
            return div;
        }

        function toggleAIChat() {
            document.getElementById('aiChatContainer').classList.toggle('active');
        }

        // --- DOSYA Y√úKLEME (OTOMATƒ∞K VE MANUEL) ---
        
        // GitHub'daki data.kml
        async function autoLoadGithubKML() {
            try {
                const res = await fetch('./data.kml');
                if(res.ok) {
                    const text = await res.text();
                    const layer = omnivore.kml.parse(text);
                    await processLayer('Ana Veri (KML)', layer);
                    console.log('‚úÖ data.kml y√ºklendi');
                }
            } catch(e) { console.warn('data.kml y√ºklenemedi'); }
        }

        // GitHub'daki KMZ (ƒ∞sim d√ºzeltildi: pym-gayrimenkul.kmz)
        async function autoLoadGithubKMZ() {
            const fileName = 'pym-gayrimenkul.kmz'; 
            try {
                const res = await fetch('./' + fileName);
                if(res.ok) {
                    const blob = await res.blob();
                    const zip = new JSZip();
                    const contents = await zip.loadAsync(blob);
                    const kmlFile = Object.keys(contents.files).find(n => n.endsWith('.kml'));
                    if(kmlFile) {
                        const kmlText = await contents.files[kmlFile].async('string');
                        const layer = omnivore.kml.parse(kmlText);
                        await processLayer('Pym Gayrimenkul', layer);
                        console.log('‚úÖ KMZ y√ºklendi');
                    }
                }
            } catch(e) { console.warn('KMZ y√ºklenemedi:', e); }
        }

        function setupFileUpload() {
            const input = document.getElementById('fileInput');
            const area = document.getElementById('uploadArea');
            
            area.onclick = () => input.click();
            input.onchange = (e) => handleFiles(e.target.files);
            area.ondragover = (e) => { e.preventDefault(); area.style.borderColor = '#007973'; };
            area.ondragleave = () => area.style.borderColor = '#E8E8E8';
            area.ondrop = (e) => {
                e.preventDefault(); area.style.borderColor = '#E8E8E8';
                handleFiles(e.dataTransfer.files);
            };
        }

        async function handleFiles(files) {
            for(const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                if(ext === 'kml') {
                    const text = await file.text();
                    processLayer(file.name, omnivore.kml.parse(text));
                } else if(ext === 'kmz') {
                    const zip = await new JSZip().loadAsync(file);
                    const kmlName = Object.keys(zip.files).find(n => n.endsWith('.kml'));
                    if(kmlName) {
                        const text = await zip.files[kmlName].async('string');
                        processLayer(file.name, omnivore.kml.parse(text));
                    }
                } else if(ext === 'geojson' || ext === 'json') {
                    const json = JSON.parse(await file.text());
                    processLayer(file.name, L.geoJSON(json));
                }
            }
        }

        async function processLayer(name, layer) {
            // Popup ayarla
            layer.eachLayer(l => {
                if(l.feature && l.feature.properties) {
                    let content = `<b>${name}</b><br>`;
                    for(const [key, val] of Object.entries(l.feature.properties)) {
                        content += `<b>${key}:</b> ${val}<br>`;
                    }
                    l.bindPopup(content);
                }
            });

            loadedFiles.push({ name, layer, visible: true });
            map.addLayer(layer);
            updateFileList();
            
            // Eƒüer harita sƒ±nƒ±rlarƒ± ge√ßerliyse oraya odaklan
            try { map.fitBounds(layer.getBounds()); } catch(e){}
        }

        // --- ARAY√úZ YARDIMCILARI ---
        function updateFileList() {
            const list = document.getElementById('fileList');
            list.innerHTML = loadedFiles.map((f, i) => `
                <div class="file-item">
                    <div class="file-name">${f.name}</div>
                    <div class="file-actions">
                        <button class="btn btn-toggle ${f.visible?'':'hidden'}" onclick="toggleLayer(${i})">üëÅÔ∏è</button>
                        <button class="btn btn-remove" onclick="removeLayer(${i})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleLayer(i) {
            const f = loadedFiles[i];
            f.visible = !f.visible;
            f.visible ? map.addLayer(f.layer) : map.removeLayer(f.layer);
            updateFileList();
        }

        function removeLayer(i) {
            if(confirm('Silinsin mi?')) {
                map.removeLayer(loadedFiles[i].layer);
                loadedFiles.splice(i, 1);
                updateFileList();
            }
        }

        function setupDrawingTools() {
            const drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: { marker: false, polyline: false, polygon: false, circle: false, rectangle: false, circlemarker: false }
            });
            map.addControl(drawControl);
            map.on(L.Draw.Event.CREATED, e => {
                drawnItems.addLayer(e.layer);
                // √áizim yapƒ±ldƒ±ƒüƒ±nda da firebase'e kaydetme eklenebilir
            });
        }

        function startDrawing(type) {
            const tool = {
                marker: new L.Draw.Marker(map),
                polyline: new L.Draw.Polyline(map),
                polygon: new L.Draw.Polygon(map)
            }[type];
            if(tool) tool.enable();
        }

        function clearDrawings() {
            if(confirm('√áizimler silinsin mi?')) drawnItems.clearLayers();
        }

        function changeMapStyle() {
            const style = document.getElementById('mapStyleSelector').value;
            map.removeLayer(currentLayer);
            if(style === 'satellite') {
                currentLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {maxZoom: 19});
            } else if(style === 'hybrid') {
                currentLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']});
            } else {
                currentLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19});
            }
            currentLayer.addTo(map);
        }

        function checkUserName() {
            if(localStorage.getItem('currentUser')) {
                currentUser = localStorage.getItem('currentUser');
            } else {
                document.getElementById('nameModalOverlay').classList.add('active');
                document.getElementById('nameModal').
